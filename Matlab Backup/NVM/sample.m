%% Defination of Sampling region 
function [k]=sample(p,a1,a2,a3) % sub-function
global M 
%% Coners
if p(1)==1&&p(2)==1&&p(3)==1
    [X,Y,Z]=meshgrid(p(1):p(1)+1,p(2):p(2)+1,p(3):p(3)+1);
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    k=s2(M(p(1):p(1)+1,p(2):p(2)+1,p(3):p(3)+1)==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];
elseif p(1)==1&&p(2)==1&&p(3)==a3
    [X,Y,Z]=meshgrid(p(1):p(1)+1,p(2):p(2)+1,p(3)-1:p(3));
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    k=s2(M(p(1):p(1)+1,p(2):p(2)+1,p(3)-1:p(3))==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];
elseif p(1)==1&&p(2)==a2&&p(3)==1
    [X,Y,Z]=meshgrid(p(1):p(1)+1,p(2)-1:p(2),p(3):p(3)+1);
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    k=s2(M(p(1):p(1)+1,p(2)-1:p(2),p(3):p(3)+1)==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];    
elseif p(1)==1&&p(2)==a2&&p(3)==a3
    [X,Y,Z]=meshgrid(p(1):p(1)+1,p(2)-1:p(2),p(3)-1:p(3));
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    k=s2(M(p(1):p(1)+1,p(2)-1:p(2),p(3)-1:p(3))==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];
elseif p(1)==a1&&p(2)==1&&p(3)==1
    [X,Y,Z]=meshgrid(p(1)-1:p(1),p(2):p(2)+1,p(3):p(3)+1);
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    k=s2(M(p(1)-1:p(1),p(2):p(2)+1,p(3):p(3)+1)==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];
elseif p(1)==a1&&p(2)==a2&&p(3)==1
    [X,Y,Z]=meshgrid(p(1)-1:p(1),p(2)-1:p(2),p(3):p(3)+1);
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    k=s2(M(p(1)-1:p(1),p(2)-1:p(2),p(3):p(3)+1)==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[]; 
elseif p(1)==a1&&p(2)==1&&p(3)==a3
    [X,Y,Z]=meshgrid(p(1)-1:p(1),p(2):p(2)+1,p(3)-1:p(3));
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    k=s2(M(p(1)-1:p(1),p(2):p(2)+1,p(3)-1:p(3))==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];
elseif p(1)==a1&&p(2)==a2&&p(3)==a3
    [X,Y,Z]=meshgrid(p(1)-1:p(1),p(2)-1:p(2),p(3)-1:p(3));
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    k=s2(M(p(1)-1:p(1),p(2)-1:p(2),p(3)-1:p(3))==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];
%% Lines
elseif p(1)==1&&p(2)==1&&p(3)~=1&&p(3)~=a3
    [X,Y,Z]=meshgrid(p(1):p(1)+1,p(2):p(2)+1,p(3)-1:p(3)+1);
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    s2(:,:,3)=s1(:,:,3)';
    k=s2(M(p(1):p(1)+1,p(2):p(2)+1,p(3)-1:p(3)+1)==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];
elseif p(1)==1&&p(2)==a2&&p(3)~=1&&p(3)~=a3
    [X,Y,Z]=meshgrid(p(1):p(1)+1,p(2)-1:p(2),p(3)-1:p(3)+1);
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    s2(:,:,3)=s1(:,:,3)';
    k=s2(M(p(1):p(1)+1,p(2)-1:p(2),p(3)-1:p(3)+1)==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];
elseif p(1)==a1&&p(2)==1&&p(3)~=1&&p(3)~=a3
    [X,Y,Z]=meshgrid(p(1)-1:p(1),p(2):p(2)+1,p(3)-1:p(3)+1);
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    s2(:,:,3)=s1(:,:,3)';
    k=s2(M(p(1)-1:p(1),p(2):p(2)+1,p(3)-1:p(3)+1)==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];
elseif p(1)==a1&&p(2)==a2&&p(3)~=1&&p(3)~=a3
    [X,Y,Z]=meshgrid(p(1)-1:p(1),p(2)-1:p(2),p(3)-1:p(3)+1);
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    s2(:,:,3)=s1(:,:,3)';
    k=s2(M(p(1)-1:p(1),p(2)-1:p(2),p(3)-1:p(3)+1)==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];
elseif p(1)==1&&p(3)==1&&p(2)~=1&&p(2)~=a2
    [X,Y,Z]=meshgrid(p(1):p(1)+1,p(2)-1:p(2)+1,p(3):p(3)+1);
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    k=s2(M(p(1):p(1)+1,p(2)-1:p(2)+1,p(3):p(3)+1)==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];
elseif p(1)==1&&p(3)==a3&&p(2)~=1&&p(2)~=a2
    [X,Y,Z]=meshgrid(p(1):p(1)+1,p(2)-1:p(2)+1,p(3)-1:p(3));
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    k=s2(M(p(1):p(1)+1,p(2)-1:p(2)+1,p(3)-1:p(3))==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];
elseif p(1)==a1&&p(3)==1&&p(2)~=1&&p(2)~=a2
    [X,Y,Z]=meshgrid(p(1)-1:p(1),p(2)-1:p(2)+1,p(3):p(3)+1);
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    k=s2(M(p(1)-1:p(1),p(2)-1:p(2)+1,p(3):p(3)+1)==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];
elseif p(1)==a1&&p(3)==a3&&p(2)~=1&&p(2)~=a2
    [X,Y,Z]=meshgrid(p(1)-1:p(1),p(2)-1:p(2)+1,p(3)-1:p(3));
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    k=s2(M(p(1)-1:p(1),p(2)-1:p(2)+1,p(3)-1:p(3))==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];
elseif p(2)==1&&p(3)==1&&p(1)~=1&&p(1)~=a1
    [X,Y,Z]=meshgrid(p(1)-1:p(1)+1,p(2):p(2)+1,p(3):p(3)+1);
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    k=s2(M(p(1)-1:p(1)+1,p(2):p(2)+1,p(3):p(3)+1)==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];
elseif p(2)==1&&p(3)==a3&&p(1)~=1&&p(1)~=a1
    [X,Y,Z]=meshgrid(p(1)-1:p(1)+1,p(2):p(2)+1,p(3)-1:p(3));
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    k=s2(M(p(1)-1:p(1)+1,p(2):p(2)+1,p(3)-1:p(3))==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];
elseif p(2)==a2&&p(3)==1&&p(1)~=1&&p(1)~=a1
    [X,Y,Z]=meshgrid(p(1)-1:p(1)+1,p(2)-1:p(2),p(3):p(3)+1);
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    k=s2(M(p(1)-1:p(1)+1,p(2)-1:p(2),p(3):p(3)+1)==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];
elseif p(2)==a2&&p(3)==a3&&p(1)~=1&&p(1)~=a1
    [X,Y,Z]=meshgrid(p(1)-1:p(1)+1,p(2)-1:p(2),p(3)-1:p(3));
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    k=s2(M(p(1)-1:p(1)+1,p(2)-1:p(2),p(3)-1:p(3))==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];
%% Sides
elseif p(1)==1&&p(2)~=1&&p(2)~=a2&&p(3)~=1&&p(3)~=a3
    [X,Y,Z]=meshgrid(p(1):p(1)+1,p(2)-1:p(2)+1,p(3)-1:p(3)+1);
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    s2(:,:,3)=s1(:,:,3)';
    k=s2(M(p(1):p(1)+1,p(2)-1:p(2)+1,p(3)-1:p(3)+1)==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];    
elseif p(1)==a1&&p(2)~=1&&p(2)~=a2&&p(3)~=1&&p(3)~=a3
    [X,Y,Z]=meshgrid(p(1)-1:p(1),p(2)-1:p(2)+1,p(3)-1:p(3)+1);
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    s2(:,:,3)=s1(:,:,3)';
    k=s2(M(p(1)-1:p(1),p(2)-1:p(2)+1,p(3)-1:p(3)+1)==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];
elseif p(2)==1&&p(1)~=1&&p(1)~=a1&&p(3)~=1&&p(3)~=a3
    [X,Y,Z]=meshgrid(p(1)-1:p(1)+1,p(2):p(2)+1,p(3)-1:p(3)+1);
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    s2(:,:,3)=s1(:,:,3)';
    k=s2(M(p(1)-1:p(1)+1,p(2):p(2)+1,p(3)-1:p(3)+1)==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[]; 
elseif p(2)==a2&&p(1)~=1&&p(1)~=a1&&p(3)~=1&&p(3)~=a3
    [X,Y,Z]=meshgrid(p(1)-1:p(1)+1,p(2)-1:p(2),p(3)-1:p(3)+1);
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    s2(:,:,3)=s1(:,:,3)';
    k=s2(M(p(1)-1:p(1)+1,p(2)-1:p(2),p(3)-1:p(3)+1)==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[]; 
elseif p(3)==1&&p(1)~=1&&p(1)~=a1&&p(2)~=1&&p(2)~=a2
    [X,Y,Z]=meshgrid(p(1)-1:p(1)+1,p(2)-1:p(2)+1,p(3):p(3)+1);
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    k=s2(M(p(1)-1:p(1)+1,p(2)-1:p(2)+1,p(3):p(3)+1)==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[]; 
elseif p(3)==a3&&p(1)~=1&&p(1)~=a1&&p(2)~=1&&p(2)~=a2
    [X,Y,Z]=meshgrid(p(1)-1:p(1)+1,p(2)-1:p(2)+1,p(3)-1:p(3));
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    k=s2(M(p(1)-1:p(1)+1,p(2)-1:p(2)+1,p(3)-1:p(3))==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[]; 
%% Normal
else
    [X,Y,Z]=meshgrid(p(1)-1:p(1)+1,p(2)-1:p(2)+1,p(3)-1:p(3)+1);
    s1=sub2ind([a1,a2,a3],X,Y,Z);
    s2(:,:,1)=s1(:,:,1)';
    s2(:,:,2)=s1(:,:,2)';
    s2(:,:,3)=s1(:,:,3)';
    k=s2(M(p(1)-1:p(1)+1,p(2)-1:p(2)+1,p(3)-1:p(3)+1)==1);
    number=sub2ind([a1,a2,a3],p(1),p(2),p(3));
    k(k==number)=[];
end
end